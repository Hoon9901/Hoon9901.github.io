{"componentChunkName":"component---src-templates-post-tsx","path":"/spring-jpa-N+1-problem/","result":{"data":{"markdownRemark":{"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3329f2424840cf1e0b0adb92a72f0db5/668c6/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVklEQVQ4y61T207CQBDtl/sBPOiz/ofRaIwPxojEEN8gtvReSiO0WwNUut0edzYsFSWxJU4y23R298yZOTtGXddI0wxxPMP7fI5DRmfauiGEQBhGsKwJgiAE51x5WZadgPYA/SBAkiSKpW078DwfrueB5TnmixSlTNCWqUFLVVXKhXT615cpxrmMy6R/g4kGkMy0XNxc3yOeJWCMderj931VMtngeYiz3gVGI1O1IJOgxPAoUcjCYIrHhwFWq4IglDA6eyeGtGw2m92GVphilKxd/34wtB1XPRlSd2Lbjcosl29zoRJ0UlkzEdueaaOYUr8Dy53Kb6aDq8s7RNMZ0iz7B5X7Q5z2zjEem7L8AHn+cfykkEVhjP7Ti1R5rTb2VW6+rVTWoL/LEyirGqxoJqFVDzVotR09NXaiRlks8eoXOLkVWK+X8kwHwIMuk/BK4JPXrZX+Ajdo5FV2XL0eAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/3329f2424840cf1e0b0adb92a72f0db5/fcda8/1.png\"\n        srcset=\"/static/3329f2424840cf1e0b0adb92a72f0db5/12f09/1.png 148w,\n/static/3329f2424840cf1e0b0adb92a72f0db5/e4a3f/1.png 295w,\n/static/3329f2424840cf1e0b0adb92a72f0db5/fcda8/1.png 590w,\n/static/3329f2424840cf1e0b0adb92a72f0db5/efc66/1.png 885w,\n/static/3329f2424840cf1e0b0adb92a72f0db5/c83ae/1.png 1180w,\n/static/3329f2424840cf1e0b0adb92a72f0db5/668c6/1.png 1692w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>쇼핑물에서 이용자의 구매이력을 조회 시, N+1 문제가 발생해 성능저하가 일어나는 상황에서\n간단한 해결법으로 성능 향상을 이루는 법을 알아보겠습니다.</p>\n<h2 id=\"n1-문제란\" style=\"position:relative;\"><a href=\"#n1-%EB%AC%B8%EC%A0%9C%EB%9E%80\" aria-label=\"n1 문제란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>N+1 문제란?</h2>\n<p>연관 관계에서 발생하는 이슈로 연관 관계가 설정된 엔티티를 조회할 경우에 조회된 데이터 갯수(n) 만큼 연관관계의 조회 쿼리가 추가로 발생하여 데이터를 읽어오게 되는 문제</p>\n<h2 id=\"엔티티-연관관계\" style=\"position:relative;\"><a href=\"#%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84\" aria-label=\"엔티티 연관관계 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>엔티티 연관관계</h2>\n<ul>\n<li>\n<p>주문 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"orders\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Order</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LocalDateTime</span> orderDate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Enumerated</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EnumType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OrderStatus</span> orderStatus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"order\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ALL</span>\n            <span class=\"token punctuation\">,</span> orphanRemoval <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span> \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">></span></span> orderItems <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>한 주문(<code class=\"language-text\">order</code>)에는 사용자가 주문한 여러개의 상품들(<code class=\"language-text\">orderItems</code>)에 대해 <code class=\"language-text\">@OneToMany</code> 연관관계를 적용했습니다.</p>\n</li>\n<li>\n<p>주문 상품 엔티티</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OrderItem</span>  <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_item_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"item_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Item</span> item<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"order_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Order</span> order<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> orderPrice<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 주문가</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 수량</span></code></pre></div>\n<p>주문 상품(<code class=\"language-text\">orderItem</code>)은 하나의 주문(<code class=\"language-text\">order</code>)에 대해 종속(<code class=\"language-text\">@ManyToOne</code>)되있습니다.</p>\n<p>그리고 상품들에 대한 정보를 가지고있습니다 (여러개의 상품들(주문) → 하나의 상품(진열))</p>\n</li>\n</ul>\n<p>간단하게 정리하자면 </p>\n<ul>\n<li>주문에는 여러개의 주문 상품들이 들어있습니다.</li>\n<li>주문 상품은 하나의 주문에 종속되어 있습니다.</li>\n<li>주문 상품은 하나의 상품에 종속되어 있습니다 (실질적인 상품에 대한 정보들)</li>\n<li>1 주문 → N 주문 상품</li>\n</ul>\n<h2 id=\"getorderlist-메소드\" style=\"position:relative;\"><a href=\"#getorderlist-%EB%A9%94%EC%86%8C%EB%93%9C\" aria-label=\"getorderlist 메소드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>getOrderList 메소드</h2>\n<p>N+1 문제가 일어나게 되는 원인인 사용자의 주문이력을 반환하는 메소드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderHistoryDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getOrderList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">></span></span> orders <span class=\"token operator\">=</span> orderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findOrders</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> totalCount <span class=\"token operator\">=</span> orderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">countOrder</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderHistoryDto</span><span class=\"token punctuation\">></span></span> orderHistoryDtos <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span> order <span class=\"token operator\">:</span> orders<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">OrderHistoryDto</span> orderHistoryDto <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderHistoryDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderItem</span><span class=\"token punctuation\">></span></span> orderItems <span class=\"token operator\">=</span> order<span class=\"token punctuation\">.</span><span class=\"token function\">getOrderItems</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 문제가 일어나는 부분</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">OrderItem</span> orderItem <span class=\"token operator\">:</span> orderItems<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">ItemImg</span> itemImg <span class=\"token operator\">=</span> itemImgRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByItemIdAndRepImgYn</span><span class=\"token punctuation\">(</span>orderItem<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">OrderItemDto</span> orderItemDto <span class=\"token operator\">=</span> <span class=\"token class-name\">OrderItemDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>orderItem<span class=\"token punctuation\">,</span> itemImg<span class=\"token punctuation\">.</span><span class=\"token function\">getImgUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                orderHistoryDto<span class=\"token punctuation\">.</span><span class=\"token function\">addOrderItemDto</span><span class=\"token punctuation\">(</span>orderItemDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            orderHistoryDtos<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>orderHistoryDto<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageImpl</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OrderHistoryDto</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>orderHistoryDtos<span class=\"token punctuation\">,</span> pageable<span class=\"token punctuation\">,</span> totalCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 로직을 보시면은 반복문을 순회하면서 <code class=\"language-text\">order.getOrderItems()</code>를 호출할 때마다 조회 쿼리문이 추가적으로 실행되고 있습니다.</p>\n<p><code class=\"language-text\">orders</code> 리스트(사용자의 주문건들)의 사이즈 만큼 쿼리문이 실행됩니다. 만약 <code class=\"language-text\">orders</code>의 사이즈가 100이었다면 100번의 쿼리문이 더 실행되는 것입니다. 현재는 <code class=\"language-text\">order_id</code> 에 하나의 주문 번호가 조건으로 설정되는 것을 볼수있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Hibernate</span><span class=\"token operator\">:</span> \n    select\n        orderitems0_<span class=\"token punctuation\">.</span>order_id as order_id9_5_0_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>order_item_id as order_it1_5_0_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>order_item_id as order_it1_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>create_time as create_t2_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>update_time as update_t3_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>created_by as created_4_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>modified_by as modified5_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>count as count6_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>item_id as item_id8_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>order_id as order_id9_5_1_<span class=\"token punctuation\">,</span>\n        orderitems0_<span class=\"token punctuation\">.</span>order_price as order_pr7_5_1_ \n    from\n        order_item orderitems0_ \n    where   <span class=\"token comment\">// 문제의 부분</span>\n        orderitems0_<span class=\"token punctuation\">.</span>order_id<span class=\"token operator\">=</span><span class=\"token operator\">?</span></code></pre></div>\n<p>만약 <code class=\"language-text\">orders</code>의 주문 아이디를 <code class=\"language-text\">“where order_id in (id1, id2, id3, ... )”</code> 이런식으로 <code class=\"language-text\">in</code> 쿼리로 한번에 조회할 수 있다면 100개가 실행될 쿼리를 하나의 쿼리로 조회할 수 있습니다.</p>\n<h3 id=\"무엇이-문제인가\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%97%87%EC%9D%B4-%EB%AC%B8%EC%A0%9C%EC%9D%B8%EA%B0%80\" aria-label=\"무엇이 문제인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>무엇이 문제인가</h3>\n<ul>\n<li>하나의 주문을 조회하는 쿼리를 호출한다</li>\n<li>주문을 조회할때 주문상품들을 조회하는 쿼리가 하나의 주문을 조회하는 만큼 호출된다.</li>\n</ul>\n<h2 id=\"batch-size-로-해결하기\" style=\"position:relative;\"><a href=\"#batch-size-%EB%A1%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\"batch size 로 해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>batch-size 로 해결하기</h2>\n<ul>\n<li>\n<p>application.properties 설정 추가하기</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">spring<span class=\"token punctuation\">.</span>jpa<span class=\"token punctuation\">.</span>properties<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>default_batch_fetch_size<span class=\"token operator\">=</span><span class=\"token number\">1000</span></code></pre></div>\n</li>\n</ul>\n<p><code class=\"language-text\">batch-size</code> 옵션은 연관된 하위 엔티티를 로딩할 때 상위 엔티티 ID를 지정한 숫자만큼 <code class=\"language-text\">in</code> 쿼리로 로딩합니다. </p>\n<p>예로 들어 <code class=\"language-text\">batch-size:1000</code>으로 되어있으면, 상위 엔티티인 <code class=\"language-text\">order</code>의 id 1000개를 <code class=\"language-text\">in</code> 쿼리로 <code class=\"language-text\">orderItem</code>를 조회하게 됩니다.</p>\n<p>해당 옵션을 추가한 후 다시 구매 이력을 조회하면 반복문에서 <code class=\"language-text\">order.getOrderItems()</code> 최초 실행할 때 로그를 보겠습니다.</p>\n<ul>\n<li>\n<p>2건의 주문이력을 요청할때</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Hibernate</span><span class=\"token operator\">:</span> \nselect\n    orderitems0_<span class=\"token punctuation\">.</span>order_id as order_id9_5_1_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>order_item_id as order_it1_5_1_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>order_item_id as order_it1_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>create_time as create_t2_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>update_time as update_t3_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>created_by as created_4_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>modified_by as modified5_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>count as count6_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>item_id as item_id8_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>order_id as order_id9_5_0_<span class=\"token punctuation\">,</span>\n    orderitems0_<span class=\"token punctuation\">.</span>order_price as order_pr7_5_0_ \nfrom\n    order_item orderitems0_ \nwhere\n    orderitems0_<span class=\"token punctuation\">.</span>order_id in <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">?</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<p>해당 로그를 보시면은 조건절에 in 쿼리문이 실행되는 것을 볼 수 있습니다.</p>\n<p>이렇게 간단한 설정을 통해 in 쿼리문으로 조회하도록 성능 이슈를 해결했습니다\nJPA에서 N+1 을 해결하는 방법들은 여러개 이니 batch_size는 연관관계에서 데이터 사이즈를 정확하게 알고 있을 때 조심해서 사용하시면 됩니다.</p>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><a href=\"http://www.yes24.com/Product/Goods/103453774\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">스프링 부트 쇼핑몰 프로젝트 with JPA</a></p>\n<p><a href=\"https://jojoldu.tistory.com/414\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Spring Batch JPA에서 N+1 문제 해결</a></p>","excerpt":"쇼핑물에서 이용자의 구매이력을 조회 시, N+1 문제가 발생해 성능저하가 일어나는 상황에서\n간단한 해결법으로 성능 향상을 이루는 법을 알아보겠습니다. N+1 문제란? 연관 관계에서 발생하는 이슈로 연관 관계가 설정된 엔티티를 조회할 경우에 조회된 데…","tableOfContents":"<ul>\n<li><a href=\"/spring-jpa-N+1-problem/#n1-%EB%AC%B8%EC%A0%9C%EB%9E%80\">N+1 문제란?</a></li>\n<li><a href=\"/spring-jpa-N+1-problem/#%EC%97%94%ED%8B%B0%ED%8B%B0-%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84\">엔티티 연관관계</a></li>\n<li>\n<p><a href=\"/spring-jpa-N+1-problem/#getorderlist-%EB%A9%94%EC%86%8C%EB%93%9C\">getOrderList 메소드</a></p>\n<ul>\n<li><a href=\"/spring-jpa-N+1-problem/#%EB%AC%B4%EC%97%87%EC%9D%B4-%EB%AC%B8%EC%A0%9C%EC%9D%B8%EA%B0%80\">무엇이 문제인가</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/spring-jpa-N+1-problem/#batch-size-%EB%A1%9C-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">batch-size 로 해결하기</a></p>\n<ul>\n<li><a href=\"/spring-jpa-N+1-problem/#reference\">Reference</a></li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/spring-jpa-N+1-problem/"},"frontmatter":{"title":"[Spring JPA] 쇼핑물 주문이력 조회 시 N+1 문제 해결하기","date":"Jan 28, 2022","tags":["Spring JPA"],"keywords":["스프링","스프링부트","SpringBoot","Spring JPA","JPA","N+1"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/spring-jpa-N+1-problem/","series":[],"lastmod":"2022-01-28"}},"staticQueryHashes":["2027115977","694178885"]}