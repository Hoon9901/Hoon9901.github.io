{"componentChunkName":"component---src-templates-post-tsx","path":"/aws-codedeploy/","result":{"data":{"markdownRemark":{"html":"<p><a href=\"http://artscope.kr\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Artscope</a> 서비스를 AWS에 배포하기 위해 CI/CD를 구축하였는데 구축 과정과 시행착오를 기록했습니다.</p>\n<p>기존에는 개발 환경에서 깃허브로 커밋을 하게 되면 (develop 브랜치) GitAction을 통해서 Build와 Test과정을 진행하게 되는데\nDocker 이미지를 저장소에 업로드 하게 되고 온프레미스로 운영중인 개발 서버의 ArgoCD가 해당 이미지를 감지하여 Kubernetes 오브젝트로 배포를 (CD) 진행하게 됩니다. 개발 환경까지는 배포가 자동으로 진행되지만 배포 환경 (main 브랜치)에서는 업로드된 도커 이미지를 직접 가져와 AWS EC2로 배포해야하는 번거로움이 있었습니다.</p>\n<p>그래서 이번에 AWS CodeDeploy를 이용해 배포 환경까지 자동으로 배포를 진행하고자 합니다.\nCI/CD 과정은 다음과 같습니다.</p>\n<ol>\n<li>github 저장소로 commit</li>\n<li>\n<p>git action을 통해 build, test 진행 (CI)</p>\n<ol>\n<li>spring boot 프로젝트를 docker 이미지로 빌드</li>\n<li>빌드된 이미지를 docker hub에 업로드</li>\n<li>AWS S3에 새로운 이미지 버전에 대한 정보를 저장</li>\n<li>AWS CodeDeploy에 배포 요청</li>\n</ol>\n</li>\n<li>AWS CodeDeploy를 통해 AWS EC2에 배포 (CD)</li>\n</ol>\n<h3 id=\"고민한-부분\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC%ED%95%9C-%EB%B6%80%EB%B6%84\" aria-label=\"고민한 부분 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민한 부분</h3>\n<h4 id=\"aws-인스턴스는-도커-이미지를-pull하고-run만-하도록-고안\" style=\"position:relative;\"><a href=\"#aws-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4%EB%8A%94-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-pull%ED%95%98%EA%B3%A0-run%EB%A7%8C-%ED%95%98%EB%8F%84%EB%A1%9D-%EA%B3%A0%EC%95%88\" aria-label=\"aws 인스턴스는 도커 이미지를 pull하고 run만 하도록 고안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS 인스턴스는 도커 이미지를 Pull하고 Run만 하도록 고안</h4>\n<p>위 과정을 구성하며 고민한 부분은 AWS CodeDeploy 이용한 배포 레퍼런스를 찾아보니 S3에 애플리케이션 빌드 파일을 업로드 후 EC2 상에서 Docker 이미지를 빌드하고 실행하거나 곧 바로 Java 애플리케이션을 실행하는데 이런 과정으로 진행하지 않고싶었습니다. 이유는 AWS 인스턴스는 한정된 자원으로 운영중인 서비스가 있어서 S3로 부터 무거운 빌드 파일을 받아오거나 Docker 이미지 빌드 과정으로 운영중인 서비스에 조금이라도 영향이 없도록 하고 싶었습니다. </p>\n<p>그래서 고안한 방법으로 GitAction의 Task 중 새롭게 갱신된 도커 이미지명을 파일로 저장해 S3 저장소에 이미지명이 담긴 파일을 업로드하고 CodeDeploy Script상에서 해당 파일 내용을 환경변수로 저장해 컨테이너로 실행하는 방법으로 진행하였습니다.</p>\n<p>위 방법을 적용하니 스프링 빌드 파일(jar, 약 75MB)을 S3에 업로드하지 않아도 되고 도커 이미지 빌드를 EC2가 진행하지 않고 GitAction이 담당하게 되니 최종적으로 EC2 인스턴스에서는 해당 이미지를 Pull 하고 Run하는 과정만 진행하면 되어서 효율적인 방법이라고 생각해 적용했습니다.</p>\n<hr>\n<h2 id=\"1-iam-설정\" style=\"position:relative;\"><a href=\"#1-iam-%EC%84%A4%EC%A0%95\" aria-label=\"1 iam 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. IAM 설정</h2>\n<h3 id=\"11-github-action-iam-사용자-생성\" style=\"position:relative;\"><a href=\"#11-github-action-iam-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%83%9D%EC%84%B1\" aria-label=\"11 github action iam 사용자 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 Github Action IAM 사용자 생성</h3>\n<p>Github Action에서 사용할 IAM 사용자를 생성합니다. (IAM - 사용자 - 사용자 추가)</p>\n<ul>\n<li>사용자 이름 : artscope-deploy</li>\n<li>액세스 유형 : 프로그래밍 방식 액세스</li>\n<li>\n<p>권한 정책</p>\n<ul>\n<li>\n<p>인라인 정책 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"autoscaling:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"codedeploy:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"ec2:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"lambda:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"elasticloadbalancing:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"s3:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"cloudwatch:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"logs:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"sns:*\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>생성 후 보안 자격 증명 - 액세스 키 발급 (Access Key ID, Secret Access Key)</li>\n</ul>\n<p>발급받은 Key를 Github 저장소의 Secrets에 등록합니다.</p>\n<h3 id=\"12-ec2-iam-역활-생성\" style=\"position:relative;\"><a href=\"#12-ec2-iam-%EC%97%AD%ED%99%9C-%EC%83%9D%EC%84%B1\" aria-label=\"12 ec2 iam 역활 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 EC2 IAM 역활 생성</h3>\n<p>EC2에서 사용할 IAM 역활을 생성합니다. (IAM - 역활 - 역활 생성)</p>\n<ul>\n<li>역활 이름 : ec2-deploy</li>\n<li>역활 유형 : AWS 서비스</li>\n<li>\n<p>권한 정책</p>\n<ul>\n<li>AmazonEC2RoleforAWSCodeDeploy</li>\n</ul>\n</li>\n</ul>\n<p>EC2에서 CodeDeploy Agent가 S3에 접근할 수 있도록 권한을 추가합니다.</p>\n<h3 id=\"13-codedeploy-iam-역활-생성\" style=\"position:relative;\"><a href=\"#13-codedeploy-iam-%EC%97%AD%ED%99%9C-%EC%83%9D%EC%84%B1\" aria-label=\"13 codedeploy iam 역활 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 CodeDeploy IAM 역활 생성</h3>\n<p>그리고 CodeDeploy에서 사용할 IAM 역활을 생성합니다.</p>\n<ul>\n<li>역활 이름: artscope-codedeploy</li>\n<li>역활 유형: AWS 서비스</li>\n<li>\n<p>권한 정책</p>\n<ul>\n<li>AWSCodeDeployRole</li>\n</ul>\n</li>\n</ul>\n<p>CodeDeploy가 EC2에 접근할 수 있도록 권한을 추가합니다.</p>\n<h3 id=\"14-ec2에-iam-역활-연결\" style=\"position:relative;\"><a href=\"#14-ec2%EC%97%90-iam-%EC%97%AD%ED%99%9C-%EC%97%B0%EA%B2%B0\" aria-label=\"14 ec2에 iam 역활 연결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.4 EC2에 IAM 역활 연결</h3>\n<p>EC2에 IAM 역활을 연결합니다.\n저는 사용중인 EC2가 있어서 IAM 역활 수정을 했습니다 (EC2 - 인스턴스 - 인스턴스 선택 - IAM 역활 수정)</p>\n<ul>\n<li>IAM 역활 : ec2-deploy</li>\n</ul>\n<p>만약에 EC2를 새로 생성한다면 인스턴스 생성 시 생성한 IAM 역활을 선택하면 됩니다.</p>\n<hr>\n<h2 id=\"2-ec2-설정\" style=\"position:relative;\"><a href=\"#2-ec2-%EC%84%A4%EC%A0%95\" aria-label=\"2 ec2 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. EC2 설정</h2>\n<h3 id=\"21-aws-cli-설치\" style=\"position:relative;\"><a href=\"#21-aws-cli-%EC%84%A4%EC%B9%98\" aria-label=\"21 aws cli 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 AWS CLI 설치</h3>\n<p>저는 Ubuntu 22.04.2 LTS를 사용하고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> awscli</code></pre></div>\n<p>설치 후 <code class=\"language-text\">aws configure</code> 명령어를 통해 AWS 계정 정보를 입력합니다.\n저는 EC2에 IAM 역활을 연결했기 때문에 Access Key ID, Secret Access Key는 입력하지 않습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">></span> aws configure\nAWS Access Key ID <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">]</span>: \nAWS Secret Access Key <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">]</span>: \nDefault region name <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">]</span>: ap-northeast-2\nDefault output <span class=\"token function\">format</span> <span class=\"token punctuation\">[</span>None<span class=\"token punctuation\">]</span>:     </code></pre></div>\n<p>그리고 다음 명령어를 통해 iam-role을 확인합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">></span> aws configure list\n      Name                    Value             Type    Location\n      ----                    -----             ----    --------\n   profile                <span class=\"token operator\">&lt;</span>not set<span class=\"token operator\">></span>             None    None\naccess_key     ****************24FZ         iam-role    \nsecret_key     ****************xJAl         iam-role    \n    region           ap-northeast-2      config-file    ~/.aws/config</code></pre></div>\n<p>위 처럼 나오면 정상적으로 설정이 된 것입니다.\n만약에 iam-role 관련 access_key, secret_key 가 안나온다면 <code class=\"language-text\">~/.aws</code> 폴더에 credentials 파일을 확인하거나\nEC2 역활을 다시 확인하면 됩니다.</p>\n<p>이렇게 하면 EC2에서 AWS CLI, CodeDeploy Agent에 필요한 설정이 완료됩니다.</p>\n<h3 id=\"22-codedeploy-agent-설치\" style=\"position:relative;\"><a href=\"#22-codedeploy-agent-%EC%84%A4%EC%B9%98\" aria-label=\"22 codedeploy agent 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 CodeDeploy Agent 설치</h3>\n<p>다음 명령어를 실행해 CodeDeploy Agent를 설치합니다. (Ubuntu 22.04.2 LTS 기준)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ruby-full\n<span class=\"token builtin class-name\">cd</span> ~ <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">wget</span> https://aws-codedeploy-ap-northeast-2.s3.ap-northeast-2.amazonaws.com/latest/install\n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> +x ./install\n<span class=\"token function\">sudo</span> ./install auto</code></pre></div>\n<p>설치가 완료되면 다음 명령어를 통해 CodeDeploy Agent가 정상적으로 실행되는지 확인합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> codedeploy-agent status</code></pre></div>\n<p>EC2 재시작되면 CodeDeploy Agent가 자동으로 실행되도록 설정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 다음 명령어를 실행합니다</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/init.d/codedeploy-startup.sh\n\n<span class=\"token comment\"># 다음 내용으로 작성합니다</span>\n<span class=\"token comment\">#!/bin/bash </span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Starting codedeploy-agent'</span> \n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> codedeploy-agent restart\n\n\n<span class=\"token comment\"># 실행 권한을 추가합니다</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> +x /etc/init.d/codedeploy-startup.sh</code></pre></div>\n<p>이제 EC2에 CodeDeploy Agent가 정상적으로 설치되었습니다.</p>\n<hr>\n<h2 id=\"3-codedeploy-설정\" style=\"position:relative;\"><a href=\"#3-codedeploy-%EC%84%A4%EC%A0%95\" aria-label=\"3 codedeploy 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. CodeDeploy 설정</h2>\n<h3 id=\"31-codedeploy-생성\" style=\"position:relative;\"><a href=\"#31-codedeploy-%EC%83%9D%EC%84%B1\" aria-label=\"31 codedeploy 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 CodeDeploy 생성</h3>\n<p>CodeDeploy 애플리케이션을 생성합니다.</p>\n<ul>\n<li>\n<p>CodeDeploy - 애플리케이션 - 애플리케이션 생성</p>\n<ul>\n<li>애플리케이션 이름 : artscope-codedeploy</li>\n</ul>\n</li>\n</ul>\n<p>그리고 배포 그룹을 생성합니다.</p>\n<ul>\n<li>\n<p>CodeDeploy - 배포 그룹 - 배포 그룹 생성</p>\n<ul>\n<li>배포 그룹 이름 : artscope-codedeploy-group</li>\n<li>서비스 역활 : artscope-codedeploy (이전에 생성한 IAM 역활입니다.)</li>\n<li>배포 유형 : 현재 위치</li>\n<li>\n<p>환경 구성 </p>\n<ul>\n<li>Amazon EC2 인스턴스</li>\n<li>키 : Name</li>\n<li>값 : artscope</li>\n</ul>\n</li>\n<li>배포 설정 : CodeDeployDefault.OneAtATime</li>\n<li>로드 밸런싱 : 없음</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"32-codedeploy-appspec-생성\" style=\"position:relative;\"><a href=\"#32-codedeploy-appspec-%EC%83%9D%EC%84%B1\" aria-label=\"32 codedeploy appspec 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 CodeDeploy AppSpec 생성</h3>\n<p>CodeDeploy에서 배포할 때 필요한 설정 파일입니다.\n프로젝트에서 다음 파일을 생성했습니다.</p>\n<ul>\n<li>./appspec.yml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span>\n<span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> linux\n<span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> /\n    <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> /home/ubuntu/deploy/\n    <span class=\"token key atrule\">overwrite</span><span class=\"token punctuation\">:</span> yes\n\n<span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">object</span><span class=\"token punctuation\">:</span> /home/ubuntu/deploy/\n    <span class=\"token key atrule\">pattern</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"**\"</span>\n    <span class=\"token key atrule\">owner</span><span class=\"token punctuation\">:</span> root\n    <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> root\n    <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">777</span>\n\n<span class=\"token key atrule\">hooks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ApplicationStop</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> scripts/stop.sh\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n      <span class=\"token key atrule\">runas</span><span class=\"token punctuation\">:</span> root\n\n  <span class=\"token key atrule\">ApplicationStart</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">location</span><span class=\"token punctuation\">:</span> scripts/start.sh\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n      <span class=\"token key atrule\">runas</span><span class=\"token punctuation\">:</span> root</code></pre></div>\n<p>CodeDeploy에는 다음과 같은 단계가 있습니다.</p>\n<ul>\n<li>ApplicationStop</li>\n<li>DownloadBundle</li>\n<li>BeforeInstall</li>\n<li>Install</li>\n<li>AfterInstall</li>\n<li>ApplicationStart</li>\n<li>ValidateService</li>\n</ul>\n<p>저는 ApplicationStop, ApplicationStart 단계에서 스크립트를 실행하도록 했습니다.</p>\n<h3 id=\"33-codedeploy-배포-스크립트-생성\" style=\"position:relative;\"><a href=\"#33-codedeploy-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%83%9D%EC%84%B1\" aria-label=\"33 codedeploy 배포 스크립트 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 CodeDeploy 배포 스크립트 생성</h3>\n<p>CodeDeploy에서 배포할 때 필요한 스크립트 파일입니다.\n프로젝트에서 다음 파일을 생성했습니다.</p>\n<ul>\n<li>./scripts/stop.sh</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">CONTAINER_NAME</span><span class=\"token operator\">=</span>art-backend\n\n<span class=\"token comment\"># 도커 컨테이너가 있는지 확인 (-a 옵션으로 정지된 컨테이너도 확인)</span>\n<span class=\"token assign-left variable\">RUNNING_CONTAINER_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">-aq</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$CONTAINER_NAME</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"실행중인 컨테이너 ID: <span class=\"token variable\">$RUNNING_CONTAINER_ID</span>\"</span>\n\n<span class=\"token comment\"># 이전 도커 컨테이너 종료</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$RUNNING_CONTAINER_ID</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"이전 도커 컨테이너 종료 및 삭제합니다\"</span>\n  <span class=\"token function\">docker</span> stop <span class=\"token variable\">$CONTAINER_NAME</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">docker</span> <span class=\"token function\">rm</span> <span class=\"token variable\">$CONTAINER_NAME</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>위 스크립트는 실행 중인 컨테이너가 있다면 종료하고 삭제합니다.</p>\n<ul>\n<li>./scripts/start.sh</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">IMAGE_FILE_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"/home/ubuntu/deploy/image.txt\"</span>\n<span class=\"token assign-left variable\">IMAGE_NAME</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> <span class=\"token string\">\"<span class=\"token variable\">$IMAGE_FILE_PATH</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">CONTAINER_ENV_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"/home/ubuntu/env/.env\"</span>\n<span class=\"token assign-left variable\">SERVICE_NAME</span><span class=\"token operator\">=</span>art-be\n\n<span class=\"token comment\"># Docker Compose YAML을 새로운 도커 버전으로 작성해서 저장</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"version: '3.8'\n\nservices:\n  art-be:\n    container_name: art-backend\n    image: <span class=\"token variable\">${IMAGE_NAME}</span>\n    ports:\n      - 8080:8080\n    env_file:\n      - <span class=\"token variable\">${CONTAINER_ENV_PATH}</span>\n    volumes:\n      - logs_data:/logs\n      - /home/ubuntu/art-be/pinpoint/profiles:/pinpoint-agent/profiles:rw\n      - pinpoint-volumes:/pinpoint-agent\n    depends_on:\n      - redis\n      - pinpoint-agent\n      - filebeat\n\n  pinpoint-agent:\n    container_name: art-pinpoint-agent\n    image: pinpointdocker/pinpoint-agent:2.5.2\n    volumes:\n      - pinpoint-volumes:/pinpoint-agent\n\n  redis:\n    image: redis:7.0-alpine\n    command: redis-server --port 6379\n    container_name: art-redis\n    labels:\n      - \"</span><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>redis<span class=\"token string\">\"\n      - \"</span>mode<span class=\"token operator\">=</span>standalone<span class=\"token string\">\"\n    ports:\n      - 6379:6379\n\n  filebeat:\n    image: filebeat-custom:0.18\n    container_name: art-filebeat\n    volumes:\n      - logs_data:/logs\n    ports:\n      - 5044:5044\n\nvolumes:\n  logs_data:\n  pinpoint-volumes:\n\nnetworks:\n  default:\n    name: art\n    external: true\"</span> <span class=\"token operator\">></span> docker-compose.yaml\n\n<span class=\"token comment\"># 새로운 도커 컨테이너 실행</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"IMAGE_NAME: <span class=\"token variable\">$IMAGE_NAME</span> 도커 실행\"</span>\n<span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span> <span class=\"token variable\">$SERVICE_NAME</span></code></pre></div>\n<p>새로운 도커 이미지 버전을 알기위해 <code class=\"language-text\">/home/ubuntu/deploy/</code> 경로에 저장된 <code class=\"language-text\">image.txt</code> 파일을 읽어 <code class=\"language-text\">IMAGE_NAME</code> 환경변수에 저장합니다.\n그리고 저는 스프링 애플리케이션 뿐만 아니라 pinpoint, redis, filebeat도 함께 실행하기 때문에 docker-compose를 이용해 실행하고 싶어서 갱신된 스프링 서버의 이미지 버전 (<code class=\"language-text\">$IMAGE\\_NAME</code>)을 이용하는 docker-compose.yaml을 생성합니다. 그리고 <code class=\"language-text\">docker-compose up -d {서비스_이름}</code> 명령어로 컨테이너를 실행합니다.</p>\n<p><code class=\"language-text\">image.txt</code> 파일은 Github Action에서 생성하고 S3에 업로드합니다. 그리고 CodeDeploy 배포 요청이 시작되면 Agent가 EC2 인스턴스에서 S3에서 <code class=\"language-text\">image.txt</code> 파일이 담긴 zip을 다운로드 받아 사용합니다.</p>\n<hr>\n<h2 id=\"4-github-action-설정\" style=\"position:relative;\"><a href=\"#4-github-action-%EC%84%A4%EC%A0%95\" aria-label=\"4 github action 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. GitHub Action 설정</h2>\n<h3 id=\"41-github-action-tasks-작성\" style=\"position:relative;\"><a href=\"#41-github-action-tasks-%EC%9E%91%EC%84%B1\" aria-label=\"41 github action tasks 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 Github Action Tasks 작성</h3>\n<p>프로젝트에서 다음 파일을 생성했습니다.</p>\n<ul>\n<li>.github/workflows/prod-ci.yml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Docker Prod CI\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">REGISTRY</span><span class=\"token punctuation\">:</span> docker.io\n  <span class=\"token key atrule\">IMAGE_NAME</span><span class=\"token punctuation\">:</span> repository/image<span class=\"token punctuation\">-</span>name\n  <span class=\"token key atrule\">DOCKER_REGISTRY_USERNAME</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">DOCKER_REGISTRY_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">JASYPT_ENCRYPTOR_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.JASYPT_ENCRYPTOR_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">AWS_S3_BUCKET_NAME</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_S3_BUCKET_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># S3 버킷 이름</span>\n  <span class=\"token key atrule\">AWS_CODE_DEPLOY_NAME</span><span class=\"token punctuation\">:</span> artscope<span class=\"token punctuation\">-</span>codedeploy <span class=\"token comment\"># CodeDeploy 애플리케이션 이름</span>\n  <span class=\"token key atrule\">AWS_CODE_DEPLOY_GROUP</span><span class=\"token punctuation\">:</span> artscope<span class=\"token punctuation\">-</span>codedeploy<span class=\"token punctuation\">-</span>group <span class=\"token comment\"># CodeDeploy 배포 그룹 이름</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n    \n  <span class=\"token key atrule\">build-dockerized-production</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and push Docker image\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token punctuation\">...</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v3\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up JDK 11\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>java@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">java-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'11'</span>\n          <span class=\"token key atrule\">distribution</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'temurin'</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache Gradle packages\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            ~/.gradle/caches\n            ~/.gradle/wrapper</span>\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>gradle<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/*.gradle*'</span><span class=\"token punctuation\">,</span> '<span class=\"token important\">**/gradle-wrapper.properties')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            ${{ runner.os }}-gradle-    </span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Grant execute permission for gradlew\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> chmod +x ./gradlew\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build with Gradle\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> gradle/gradle<span class=\"token punctuation\">-</span>build<span class=\"token punctuation\">-</span>action@v2.4.2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            build</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Docker buildx\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/setup<span class=\"token punctuation\">-</span>buildx<span class=\"token punctuation\">-</span>action@79abd3f86f79a9d68a23c75a09a9a85889262adf\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build the Docker image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>tag $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MAJOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>.$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MINOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">-</span>f Dockerfile.prod .\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Login to registry $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.REGISTRY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo \"$DOCKER_REGISTRY_PASSWORD\" <span class=\"token punctuation\">|</span> docker login \"$REGISTRY\" <span class=\"token punctuation\">-</span>u \"$DOCKER_REGISTRY_USERNAME\" <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>password<span class=\"token punctuation\">-</span>stdin\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Push to $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.REGISTRY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker push $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MAJOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>.$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MINOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\"># Docker 이미지 이름을 image.txt 파일에 쓰기</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Write Docker image name to file\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo \"$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MAJOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>.$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.MINOR <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\" <span class=\"token punctuation\">></span> image.txt\n\n      <span class=\"token comment\"># CodeDeploy 배포를 위한 관련 파일 압축</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create zip file for AWS CodeDeploy\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mkdir $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AWS_CODE_DEPLOY_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token important\">&amp;&amp;</span> cp <span class=\"token punctuation\">-</span>r appspec.yml image.txt scripts $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AWS_CODE_DEPLOY_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\"># AWS 설정</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AWS Configure\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>actions/configure<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>credentials@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">aws-access-key-id</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_ACCESS_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-secret-access-key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AWS_SECRET_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">aws-region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">2</span>\n\n      <span class=\"token comment\"># AWS S3로 배포 파일 업로드</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Upload to AWS S3\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          aws deploy push \\\n            --application-name ${{ env.AWS_CODE_DEPLOY_NAME }} \\\n            --s3-location s3://${{ env.AWS_S3_BUCKET_NAME }}/codedeploy/$GITHUB_SHA.zip \\\n            --ignore-hidden-files \\\n            --source ${{ env.AWS_CODE_DEPLOY_NAME }}</span>\n\n      <span class=\"token comment\"># AWS EC2 CodeDeploy 배포 요청</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Delpoy to AWS EC2\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          aws deploy create-deployment \\\n            --application-name ${{ env.AWS_CODE_DEPLOY_NAME }} \\\n            --deployment-config-name CodeDeployDefault.OneAtATime \\\n            --deployment-group-name ${{ env.AWS_CODE_DEPLOY_GROUP }} \\\n            --description \"Deploy artscope\" \\\n            --s3-location bucket=$AWS_S3_BUCKET_NAME,key=codedeploy/$GITHUB_SHA.zip,bundleType=zip</span>\n          \n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Autoincrement a new minor version\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          echo \"NEW_MINOR_VERSION=$((${{ secrets.MINOR }}+1))\" >> $GITHUB_ENV</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Update Minor version\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> hmanzur/actions<span class=\"token punctuation\">-</span>set<span class=\"token punctuation\">-</span>secret@v2.0.0\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'MINOR'</span>\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.NEW_MINOR_VERSION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.REPO <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.REPO_ACCESS_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>중요한 부분이라면 다음과 같습니다.</p>\n<ul>\n<li>빌드된 Docker 이미지 이름을 <code class=\"language-text\">image.txt</code> 파일에 쓰기</li>\n<li>AWS S3로 배포 파일 업로드</li>\n<li>AWS EC2 CodeDeploy 배포 요청</li>\n</ul>\n<p>업데이트된 이미지명을 기록하고 CodeDeploy의 Script에서 사용하기 위해 <code class=\"language-text\">image.txt</code> 파일을 생성하였고 해당 파일에는 다음 내용으로 쓰여집니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">repository/image-name:1.0</code></pre></div>\n<p>CodeDeploy Agent에서 배포 작업들을 실행 하기 위해 <code class=\"language-text\">appspec.yml</code>과 <code class=\"language-text\">scripts\\</code>, <code class=\"language-text\">image.txt</code> 를 함께 압축하여 AWS S3에 업로드합니다 그리고 해당 s3 파일의 경로를 알려주면 CodeDeploy Agent가 압축을 풀고 appspec에 명시된 내용을 토대로 배포를 진행합니다.</p>\n<hr>\n<h2 id=\"5-codedeploy-실행\" style=\"position:relative;\"><a href=\"#5-codedeploy-%EC%8B%A4%ED%96%89\" aria-label=\"5 codedeploy 실행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. CodeDeploy 실행</h2>\n<p>이제 CodeDeploy를 실행해보겠습니다. <code class=\"language-text\">main</code> 브랜치에 푸시를 하면 다음과 같이 Github Actions가 실행됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99fd3ee320e2961d989b86ea71bbde7b/d8817/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVQoz2WSa3KjQAyEOUqMw3PeMIDBxsRbrtTe/0K9rcH2OpUfXQKV9M2oNVm33GH7MyodocOCUvWo7ITWz8z1KFSHY+1+6bPxryi95aMuq+2QIB+FTjoUCoU/owhXlAQ2ftrlRmpCbfcouSNhB0LCfIMbNxwqAt1wQZiuaAiWgo/SQLEpjle4bkZLaGt65jgBa0TKRBgeYMMJjpKc/BsekjVsrljwHEGAN+/w93TG97ziPs74E0+4mIBFOczaY+EBc2sxK5tym49YbIdvpZGJTzK/jJtXhkCL0Vls44LbsuHrtGIdFkTl4WsNV2lGC1e2L0UdmDOYqgbZgTcS5ZWlB4wEHnUHEy8wXJYK88ND8Y+2tB3ypmetfakyQ1qe+JkJKMESdAeWHE/TP0uoRNMv6SXId8EF5k231z56ZcufbaBl9j/wHVzSDzeuXNYGN6wJ7EeJ3L6K6YZ5+QbkDooEdD+Bz9FlQTLe/r72t/iMx9ojF731PWE5n80/ZBcTU90XKF8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/99fd3ee320e2961d989b86ea71bbde7b/fcda8/image.png\"\n        srcset=\"/static/99fd3ee320e2961d989b86ea71bbde7b/12f09/image.png 148w,\n/static/99fd3ee320e2961d989b86ea71bbde7b/e4a3f/image.png 295w,\n/static/99fd3ee320e2961d989b86ea71bbde7b/fcda8/image.png 590w,\n/static/99fd3ee320e2961d989b86ea71bbde7b/efc66/image.png 885w,\n/static/99fd3ee320e2961d989b86ea71bbde7b/c83ae/image.png 1180w,\n/static/99fd3ee320e2961d989b86ea71bbde7b/d8817/image.png 1238w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>CodeDeploy 배포 요청이 성공적으로 이뤄지면 다음과 같이 배포 내역을 확인할 수 있습니다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0e52345bd8c1d99339ecc02620662606/264eb/image-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz42SUU/EIBCE7///Qn3QB03s3UFboC0FShl3tmeNiSaSEOjCfjO79HI3Bi8vr3h6esbb+ztyzudMKcHYHkuM8NOk6yoxrknOg8R4Z14WTPOs+8s4OjjnzyATeLCunCuWJSLKypkeIozr+rhL8SgiFLhQTT9C0AMCpulQY9w5J+uiEApPksS9l/sxHkLOe4WFIMBDJaMzI2IqorrCjAa1VhXozAA/R2zbhuvtDlbEM7aKAowbayU+opSCC51sdUcXMtxSUPeCW+iw7zv2Bti5oJfJMQyDVvK1J6S1pjEr0BNYCHQrpnUTeME9XA+gEO2UMMxZE/v+G9gTKO1g3EvJfd//DTwdKjArEP8FrgqsuHk6KbIvuP4AphNo5RdiMocVwFfJ7OWvJXc+oxZ5afOBtlfpYYMJSXooQDRNYjIHH4J9JJBOjTzSt8OtPoAJVV62XAUorqs4pHNCWzuAp0NxOwyjVuIUaJEF+AnPIQT6AguodAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/0e52345bd8c1d99339ecc02620662606/fcda8/image-1.png\"\n        srcset=\"/static/0e52345bd8c1d99339ecc02620662606/12f09/image-1.png 148w,\n/static/0e52345bd8c1d99339ecc02620662606/e4a3f/image-1.png 295w,\n/static/0e52345bd8c1d99339ecc02620662606/fcda8/image-1.png 590w,\n/static/0e52345bd8c1d99339ecc02620662606/264eb/image-1.png 867w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>배포가 성공적으로 이뤄지면 EC2에 접속하면 실행된 컨테이너와 배포 파일을 확인할 수 있습니다.</p>\n<ul>\n<li>배포된 컨테이너\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29cd593a21305263c59b71ba2d316085/f0685/image-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxElEQVQY01WQ2aqEQAxE211xwwWXQUQRURT1QRH0//+rhgrcC/NQkNCpU+mo8zxxHAeKosA0TajrGmEYIkkSuK4LpdS/8jzHvu/ybhgGNE2D53kYhgG+70PXdSgC7/tG13UoyxKfz0fgBNq2/QOkieH0jOOIOI4FSA/FXl3Xhfd90bYt0jQVGMFZlsE0zR9gEATo+x7rumJZFgngpvRQrGXDv0SCqqpC0zRSR1EkqZTjOPLVeZ7xPA+2bZM5noWzlGVZ+ALcAGSEmrpPrwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/29cd593a21305263c59b71ba2d316085/fcda8/image-2.png\"\n        srcset=\"/static/29cd593a21305263c59b71ba2d316085/12f09/image-2.png 148w,\n/static/29cd593a21305263c59b71ba2d316085/e4a3f/image-2.png 295w,\n/static/29cd593a21305263c59b71ba2d316085/fcda8/image-2.png 590w,\n/static/29cd593a21305263c59b71ba2d316085/f0685/image-2.png 835w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>배포 파일\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 388px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/28d6cd6030b12b057ba994c0bc0d5d2d/96c67/image-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACNElEQVQ4y5VT2XLaQBCUANtIAgkjg8R9GCNuEIc4hJBsBKmAXYSn/EX+/60zu4nLOE4qyUPXbO1IvT0zPcJut8N4PIbjOJhOp+h0OqjX62i32/zc7/cxGo3QarWQy+Xgui4WiwUmkwny+Ty/EwThDefzGb7vw/M8dLtdzOdzqKqKwWCAIAjQoztGUiwWOSn7LgxDWJaFeDwOwzB4ZGSiKELYUnK+XGJM6tabDTpE0B8MYZOC7k91TEmhUIAsy2g0GrwCBkbGKnkl5DgdDziEW4Qbj8e1M+PYBz623hqr1YqrY0gkEpywUqmgXC4jlUrxxxiSySRM04TwzSrg2VRxyibxklGwV2M46BL22jXOWQVfS2ncZbNcDVPIyEqlEo+MkN1nMhlIkgRN0yC0VRlC7BoWDeDeaqHaeIBumPzMSnBjwvum/w2rIjU1Qeqo9POXE0bDIRY0mHT6FiJ94MsiouLbD7zxF/EDbF2FrKUwGdvcNs5sBpX6wZI3VzF4cQGR/1FYitJrkgI9k0WaeuVufDyQPbqk1DBzWF4JiP1Jze8wpB7F6aDHROQUCU6riZnVwOi+inREwCMRir+UeokPhC+mhk9mCs9FHceCjs+5W7hKBL52gyPlnkoGxGj03xUGtHpLcn+wDeEFj5gulujQljRp6oPxBD4Zn61frVbjNun1emg2m6hWqxhSW2zbfj+kGiXYEFLkoTtdR0JRkCQDM8iy9CNHRDrl2Ea87i/zHyNluCT8Do78TlhlYApKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/28d6cd6030b12b057ba994c0bc0d5d2d/96c67/image-3.png\"\n        srcset=\"/static/28d6cd6030b12b057ba994c0bc0d5d2d/12f09/image-3.png 148w,\n/static/28d6cd6030b12b057ba994c0bc0d5d2d/e4a3f/image-3.png 295w,\n/static/28d6cd6030b12b057ba994c0bc0d5d2d/96c67/image-3.png 388w\"\n        sizes=\"(max-width: 388px) 100vw, 388px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n</ul>\n<p>이렇게 AWS CodeDeploy와 Github Action, Docker를 이용해 CI/CD를 구축하였습니다.</p>\n<hr>\n<h1 id=\"시행착오\" style=\"position:relative;\"><a href=\"#%EC%8B%9C%ED%96%89%EC%B0%A9%EC%98%A4\" aria-label=\"시행착오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>시행착오</h1>\n<p>구축 과정을 진행하며 저는 여러 오류를 겪었습니다. 그 중 몇 가지를 정리해보겠습니다.</p>\n<h2 id=\"1-awscodedeploycommanderrorsaccessdeniedexception\" style=\"position:relative;\"><a href=\"#1-awscodedeploycommanderrorsaccessdeniedexception\" aria-label=\"1 awscodedeploycommanderrorsaccessdeniedexception permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Aws::CodeDeployCommand::Errors::AccessDeniedException</h2>\n<h3 id=\"문제점\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h3>\n<p>CodeDeploy로 배포 요청을 보냈지만 다음과 같은 오류가 발생했습니다.</p>\n<ul>\n<li>\n<p>aws codedeploy agent log</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2023</span>-07-22T10:56:39 ERROR <span class=\"token punctuation\">[</span>codedeploy-agent<span class=\"token punctuation\">(</span><span class=\"token number\">3744996</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller: Error polling <span class=\"token keyword\">for</span> <span class=\"token function\">host</span> commands: Aws::CodeDeployCommand::Errors::AccessDeniedException - Aws::CodeDeployCommand::Errors::AccessDeniedException - /opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/raise_response_errors.rb:17:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/jsonvalue_converter.rb:22:in <span class=\"token variable\">`</span></span>call<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/idempotency_token.rb:19:in `call'</span>\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/param_converter.rb:26:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/request_callback.rb:71:in <span class=\"token variable\">`</span></span>call<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/response_paging.rb:12:in `call'</span>\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/response_target.rb:24:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/request.rb:72:in <span class=\"token variable\">`</span></span>send_request<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/codedeploy-commands-1.0.0/sdks/codedeploy_commands_sdk.rb:856:in `poll_host_command'</span>\n/opt/codedeploy-agent/lib/instance_agent/plugins/codedeploy/command_poller.rb:170:in <span class=\"token variable\"><span class=\"token variable\">`</span>next_command'\n/opt/codedeploy-agent/lib/instance_agent/plugins/codedeploy/command_poller.rb:94:in <span class=\"token variable\">`</span></span>perform<span class=\"token string\">'\n/opt/codedeploy-agent/lib/instance_agent/agent/base.rb:28:in `run'</span>\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:44:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> run'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:86:in <span class=\"token variable\">`</span></span>with_error_handling<span class=\"token string\">'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:43:in `run'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:70:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> run_with_error_handling'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:86:in <span class=\"token variable\">`</span></span>with_error_handling<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:69:in `run_with_error_handling'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:33:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> start'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:22:in <span class=\"token variable\">`</span></span>loop<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:22:in `start'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:206:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> spawn_child'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:204:in <span class=\"token variable\">`</span></span>fork<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:204:in `spawn_child'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:196:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> spawn_children'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:195:in <span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">times</span><span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:195:in `spawn_children'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:134:in <span class=\"token variable\"><span class=\"token variable\">`</span>start'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:37:in <span class=\"token variable\">`</span></span>block <span class=\"token keyword\">in</span> start<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:36:in `fork'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:36:in <span class=\"token variable\"><span class=\"token variable\">`</span>start'\n/opt/codedeploy-agent/bin/<span class=\"token punctuation\">..</span>/lib/codedeploy-agent.rb:43:in <span class=\"token variable\">`</span></span>block <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> levels<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>main<span class=\"token operator\">></span><span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/command_support.rb:126:in `execute'</span>\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:284:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> call_command'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:297:in <span class=\"token variable\">`</span></span>call_command<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:79:in `run'</span>\n/opt/codedeploy-agent/bin/<span class=\"token punctuation\">..</span>/lib/codedeploy-agent.rb:90:in `<span class=\"token operator\">&lt;</span>main<span class=\"token operator\">></span>'\n<span class=\"token number\">2023</span>-07-22T10:56:39 ERROR <span class=\"token punctuation\">[</span>codedeploy-agent<span class=\"token punctuation\">(</span><span class=\"token number\">3744996</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller: Cannot reach InstanceService: Aws::CodeDeployCommand::Errors::AccessDeniedException - Aws::CodeDeployCommand::Errors::AccessDeniedException</code></pre></div>\n</li>\n</ul>\n<h3 id=\"해결방안\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88\" aria-label=\"해결방안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결방안</h3>\n<p>AcessDeniedException 에러가 발생했는데 이는 IAM Role에 CodeDeploy에 대한 권한이 없어서 발생한 문제였습니다. 그래서 IAM Role에 CodeDeploy에 대한 권한을 추가해주었습니다.</p>\n<h2 id=\"2-awscodedeploycommanderrorsunrecognizedclientexception---the-security-token-included-in-the-request-is-invalid\" style=\"position:relative;\"><a href=\"#2-awscodedeploycommanderrorsunrecognizedclientexception---the-security-token-included-in-the-request-is-invalid\" aria-label=\"2 awscodedeploycommanderrorsunrecognizedclientexception   the security token included in the request is invalid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Aws::CodeDeployCommand::Errors::UnrecognizedClientException - The security token included in the request is invalid.</h2>\n<h3 id=\"문제점-1\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\" aria-label=\"문제점 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h3>\n<ul>\n<li>\n<p>aws codedeploy agent log</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2023</span>-07-25T00:00:00 ERROR <span class=\"token punctuation\">[</span>codedeploy-agent<span class=\"token punctuation\">(</span><span class=\"token number\">8749</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller: Error polling <span class=\"token keyword\">for</span> <span class=\"token function\">host</span> commands: Aws::CodeDeployCommand::Errors::UnrecognizedClientException - The security token included <span class=\"token keyword\">in</span> the request is invalid. - /opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/raise_response_errors.rb:17:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/jsonvalue_converter.rb:22:in <span class=\"token variable\">`</span></span>call<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/idempotency_token.rb:19:in `call'</span>\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/param_converter.rb:26:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/request_callback.rb:71:in <span class=\"token variable\">`</span></span>call<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/aws-sdk-core/plugins/response_paging.rb:12:in `call'</span>\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/plugins/response_target.rb:24:in <span class=\"token variable\"><span class=\"token variable\">`</span>call'\n/opt/codedeploy-agent/vendor/gems/aws-sdk-core-3.121.1/lib/seahorse/client/request.rb:72:in <span class=\"token variable\">`</span></span>send_request<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/codedeploy-commands-1.0.0/sdks/codedeploy_commands_sdk.rb:856:in `poll_host_command'</span>\n/opt/codedeploy-agent/lib/instance_agent/plugins/codedeploy/command_poller.rb:170:in <span class=\"token variable\"><span class=\"token variable\">`</span>next_command'\n/opt/codedeploy-agent/lib/instance_agent/plugins/codedeploy/command_poller.rb:94:in <span class=\"token variable\">`</span></span>perform<span class=\"token string\">'\n/opt/codedeploy-agent/lib/instance_agent/agent/base.rb:28:in `run'</span>\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:44:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> run'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:86:in <span class=\"token variable\">`</span></span>with_error_handling<span class=\"token string\">'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:43:in `run'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:70:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> run_with_error_handling'\n/opt/codedeploy-agent/lib/instance_agent/runner/child.rb:86:in <span class=\"token variable\">`</span></span>with_error_handling<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:69:in `run_with_error_handling'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:33:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> start'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:22:in <span class=\"token variable\">`</span></span>loop<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/child.rb:22:in `start'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:206:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> spawn_child'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:204:in <span class=\"token variable\">`</span></span>fork<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:204:in `spawn_child'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:196:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> spawn_children'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:195:in <span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">times</span><span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:195:in `spawn_children'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:134:in <span class=\"token variable\"><span class=\"token variable\">`</span>start'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:37:in <span class=\"token variable\">`</span></span>block <span class=\"token keyword\">in</span> start<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:36:in `fork'</span>\n/opt/codedeploy-agent/vendor/gems/process_manager-0.0.13/lib/process_manager/master.rb:36:in <span class=\"token variable\"><span class=\"token variable\">`</span>start'\n/opt/codedeploy-agent/bin/<span class=\"token punctuation\">..</span>/lib/codedeploy-agent.rb:43:in <span class=\"token variable\">`</span></span>block <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> levels<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>main<span class=\"token operator\">></span><span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/command_support.rb:126:in `execute'</span>\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:284:in <span class=\"token variable\"><span class=\"token variable\">`</span>block <span class=\"token keyword\">in</span> call_command'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:297:in <span class=\"token variable\">`</span></span>call_command<span class=\"token string\">'\n/opt/codedeploy-agent/vendor/gems/gli-2.11.0/lib/gli/app_support.rb:79:in `run'</span>\n/opt/codedeploy-agent/bin/<span class=\"token punctuation\">..</span>/lib/codedeploy-agent.rb:90:in `<span class=\"token operator\">&lt;</span>main<span class=\"token operator\">></span>'\n<span class=\"token number\">2023</span>-07-25T00:00:00 ERROR <span class=\"token punctuation\">[</span>codedeploy-agent<span class=\"token punctuation\">(</span><span class=\"token number\">8749</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller: Cannot reach InstanceService: Aws::CodeDeployCommand::Errors::UnrecognizedClientException - The security token included <span class=\"token keyword\">in</span> the request is invalid.</code></pre></div>\n</li>\n</ul>\n<p>IAM 권한에 대한 문제는 없었는데 지속적으로 Agent에서 에러가 발생했습니다 Agent 로그 상에서도\n<code class=\"language-text\">Aws::CodeDeployCommand::Errors::UnrecognizedClientException - The security token included in the request is invalid.</code>\nSecret token이 유효하지 않다고 메시지가 보였습니다.</p>\n<p>IAM 액세스 키나 EC2 IAM 역활도 여러 권한을 추가하고 Agent를 재설치하거나 EC2를 재시작해도 해결이 되지 않아 CodeDeploy Agent aws_wire_log를 활성화하여 해당 로그를 확인해봤습니다.</p>\n<ul>\n<li>aws codedeploy agent aws_wire log</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">opening connection to codedeploy-commands.ap-northeast-2.amazonaws.com:443<span class=\"token punctuation\">..</span>.\nopened\nstarting SSL <span class=\"token keyword\">for</span> codedeploy-commands.ap-northeast-2.amazonaws.com:443<span class=\"token punctuation\">..</span>.\nSSL established, protocol: TLSv1.2, cipher: ECDHE-RSA-AES128-GCM-SHA256\n<span class=\"token operator\">&lt;</span>- <span class=\"token string\">\"POST / HTTP/1.1<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Content-Type: application/x-amz-json-1.1<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Accept-Encoding: <span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>User-Agent: aws-sdk-ruby3/3.121.1 ruby/3.0.2 x86_64-linux-gnu aws-sdk-codedeploycommand/1.0.0<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>X-Amz-Target: CodeDeployCommandService_v20141006.PollHostCommand<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>X-Amz-Codedeploy-Agent-Version: OFFICIAL_1.6.0-49_deb<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Host: codedeploy-commands.ap-northeast-2.amazonaws.com<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>X-Amz-Date: 20230726T071557Z<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>X-Amz-Content-Sha256: 43bee01b74391facd1d25...75a441ac49517bfc71ccf565<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Authorization: AWS4-HMAC-SHA256 Credential=AKIAX...C26VMCRNUX/20230726/ap-northeast-2/codedeploy-commands/aws4_request, SignedHeaders=content-type;host;x-amz-codedeploy-agent-version;x-amz-content-sha256;x-amz-date;x-amz-target, Signature=2271f959ef...7a6e66b278<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Content-Length: 89<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Accept: */*<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"HTTP/1.1 400 Bad Request<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"x-amzn-RequestId: 897d8a0f-869a-47ef-80d9-c13d0ec189b7<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"Date: Wed, 26 Jul 2023 07:15:57 GMT<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"Content-Type: application/x-amz-json-1.1<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"Content-Length: 107<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"connection: keep-alive<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\nreading <span class=\"token number\">107</span> bytes<span class=\"token punctuation\">..</span>.\n-<span class=\"token operator\">></span> <span class=\"token string\">\"\"</span>\n-<span class=\"token operator\">></span> <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>__type<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>UnrecognizedClientException<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>message<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>The security token included in the request is invalid.<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span>\n<span class=\"token builtin class-name\">read</span> <span class=\"token number\">107</span> bytes\nConn keep-alive\nI, <span class=\"token punctuation\">[</span><span class=\"token number\">2023</span>-07-26T07:15:57.958765 <span class=\"token comment\">#25534]  INFO -- : [Aws::CodeDeployCommand::Client 400 0.017194 0 retries] poll_host_command(host_identifier:\"arn:aws:ec2:ap-northeast-2:539239817397:instance/i-0e9fe7b11be081a65\") Aws::CodeDeployCommand::Errors::UnrecognizedClientException The security token included in the request is invalid.</span></code></pre></div>\n<p>AWS CodeDeploy Server로 Agent가 주기적으로 요청을 보내는데 이때, 요청에 대한 응답이 400 Bad Request로 오고 <code class=\"language-text\">The security token included in the request is invalid</code> 라는 메시지가 포함되어 있었습니다.</p>\n<p>이를 통해 Agent가 AWS CodeDeploy Server로 요청을 보낼 때, 요청에 대한 인증이 실패하고 있음을 알 수 있었습니다.</p>\n<p>저는 처음에 IAM 사용자나 EC2 역활이 제대로 aws configure에 등록되지 않았나 싶어서 액세스 키를 새롭게 발급해서 등록하거나, EC2 역활을 새롭게 생성해서 다시 등록해봐도 해결이 되지 않았습니다 그리고 Agent도 여러번 삭제했지만 해결이 되지 않았습니다.</p>\n<p>로그를 다시 확인하니 <code class=\"language-text\">Authorization</code> 요청 헤더에 포함된 <code class=\"language-text\">Credentials</code>를 확인해보니 제가 발급한 액세스키와 비밀키도 아니였고 EC2 역활의 액세스 키와 비밀키도 아니였습니다. 그래서 <code class=\"language-text\">.aws</code> 경로를 확인해봐도 로그에 나타나는 Credentials와 일치하는 액세스 키와 비밀키가 없었습니다.</p>\n<h3 id=\"해결방안-1\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88-1\" aria-label=\"해결방안 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결방안</h3>\n<p><code class=\"language-text\">.aws</code> 관련해서 이상한 액세스 키를 이용해 요청하니 해당 경로가 문제가 있다고 생각했습니다. 그래서 <code class=\"language-text\">ubuntu</code> 계정이 아닌 <code class=\"language-text\">root</code> 계정으로 <code class=\"language-text\">/.aws</code> 경로를 확인하니 <code class=\"language-text\">credentials</code> 파일이 존재했습니다. 해당 파일을 확인하니 요청에 담긴 Credentials의 액세스 키가 있었습니다. 이전에 root 계정으로 aws cli를 실행한 적이 있는데 이로 인해 발생한 문제였습니다. 해당 파일을 삭제하니 정상적으로 Agent가 AWS CodeDeploy Server로 요청을 보내고 응답을 받을 수 있었습니다. </p>\n<p>혹시나 저와 같은 증상이 발생한다면 <code class=\"language-text\">root</code> 나 aws cli를 사용했던 계정들의 <code class=\"language-text\">.aws</code> 폴더를 확인하면 될것 같습니다.</p>\n<h2 id=\"레퍼런스\" style=\"position:relative;\"><a href=\"#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\" aria-label=\"레퍼런스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레퍼런스</h2>\n<ul>\n<li><a href=\"https://jwkim96.tistory.com/272\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://jwkim96.tistory.com/272</a></li>\n<li><a href=\"https://jojoldu.tistory.com/281\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://jojoldu.tistory.com/281</a></li>\n</ul>","excerpt":"Artscope 서비스를 AWS에 배포하기 위해 CI/CD를 구축하였는데 구축 과정과 시행착오를 기록했습니다. 기존에는 개발 환경에서 깃허브로 커밋을 하게 되면 (develop 브랜치) GitAction을 통해서 Build와 Test과정을 진행하게 …","tableOfContents":"<ul>\n<li>\n<ul>\n<li>\n<ul>\n<li><a href=\"/aws-codedeploy/#%EA%B3%A0%EB%AF%BC%ED%95%9C-%EB%B6%80%EB%B6%84\">고민한 부분</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#1-iam-%EC%84%A4%EC%A0%95\">1. IAM 설정</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#11-github-action-iam-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%83%9D%EC%84%B1\">1.1 Github Action IAM 사용자 생성</a></li>\n<li><a href=\"/aws-codedeploy/#12-ec2-iam-%EC%97%AD%ED%99%9C-%EC%83%9D%EC%84%B1\">1.2 EC2 IAM 역활 생성</a></li>\n<li><a href=\"/aws-codedeploy/#13-codedeploy-iam-%EC%97%AD%ED%99%9C-%EC%83%9D%EC%84%B1\">1.3 CodeDeploy IAM 역활 생성</a></li>\n<li><a href=\"/aws-codedeploy/#14-ec2%EC%97%90-iam-%EC%97%AD%ED%99%9C-%EC%97%B0%EA%B2%B0\">1.4 EC2에 IAM 역활 연결</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#2-ec2-%EC%84%A4%EC%A0%95\">2. EC2 설정</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#21-aws-cli-%EC%84%A4%EC%B9%98\">2.1 AWS CLI 설치</a></li>\n<li><a href=\"/aws-codedeploy/#22-codedeploy-agent-%EC%84%A4%EC%B9%98\">2.2 CodeDeploy Agent 설치</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#3-codedeploy-%EC%84%A4%EC%A0%95\">3. CodeDeploy 설정</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#31-codedeploy-%EC%83%9D%EC%84%B1\">3.1 CodeDeploy 생성</a></li>\n<li><a href=\"/aws-codedeploy/#32-codedeploy-appspec-%EC%83%9D%EC%84%B1\">3.2 CodeDeploy AppSpec 생성</a></li>\n<li><a href=\"/aws-codedeploy/#33-codedeploy-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%83%9D%EC%84%B1\">3.3 CodeDeploy 배포 스크립트 생성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#4-github-action-%EC%84%A4%EC%A0%95\">4. GitHub Action 설정</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#41-github-action-tasks-%EC%9E%91%EC%84%B1\">4.1 Github Action Tasks 작성</a></li>\n</ul>\n</li>\n<li><a href=\"/aws-codedeploy/#5-codedeploy-%EC%8B%A4%ED%96%89\">5. CodeDeploy 실행</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#%EC%8B%9C%ED%96%89%EC%B0%A9%EC%98%A4\">시행착오</a></p>\n<ul>\n<li>\n<p><a href=\"/aws-codedeploy/#1-awscodedeploycommanderrorsaccessdeniedexception\">1. Aws::CodeDeployCommand::Errors::AccessDeniedException</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#%EB%AC%B8%EC%A0%9C%EC%A0%90\">문제점</a></li>\n<li><a href=\"/aws-codedeploy/#%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88\">해결방안</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/aws-codedeploy/#2-awscodedeploycommanderrorsunrecognizedclientexception---the-security-token-included-in-the-request-is-invalid\">2. Aws::CodeDeployCommand::Errors::UnrecognizedClientException - The security token included in the request is invalid.</a></p>\n<ul>\n<li><a href=\"/aws-codedeploy/#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\">문제점</a></li>\n<li><a href=\"/aws-codedeploy/#%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88-1\">해결방안</a></li>\n</ul>\n</li>\n<li><a href=\"/aws-codedeploy/#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\">레퍼런스</a></li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/aws-codedeploy/"},"frontmatter":{"title":"[AWS] CodeDeploy, Github action, docker-compose를 이용한 CI/CD 구축","date":"Jul 28, 2023","tags":["AWS","CodeDeploy","GitAction","Docker","docker-compose","CI/CD"],"keywords":["AWS","CodeDeploy","GitAction","Docker","docker-compose","CI/CD"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/aws-codedeploy/","series":[],"lastmod":"2023-07-28"}},"staticQueryHashes":["2027115977","694178885"]}