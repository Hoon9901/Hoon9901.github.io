{"componentChunkName":"component---src-templates-post-tsx","path":"/jpa-softdelete-annotation/","result":{"data":{"markdownRemark":{"html":"<p>기존에는 SoftDelete를 구현할려면 @Where 와 @SQLDelete 를 사용했어야했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@Where</span><span class=\"token punctuation\">(</span>clause <span class=\"token operator\">=</span> <span class=\"token string\">\"deleted = false\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@SQLDelete</span><span class=\"token punctuation\">(</span>sql <span class=\"token operator\">=</span> <span class=\"token string\">\"UPDATE member SET deleted = true WHERE id = ?\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> deleted<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@SQLDelete</code>는 Repository의 <code class=\"language-text\">delete()</code> 메서드를 호출했을 때, 대신 호출되는 SQL을 지정해주는 어노테이션인데 이를 통해 UPDATE 방식으로 삭제 처리를 하고 <code class=\"language-text\">@Where</code>를 통해 삭제되지 않은 데이터만 조회할 수 있다.</p>\n<p>이렇게 해서 SoftDelete를 구현할 수 있었지만, Hibernate 6.4 버전부터는 JPA에서 공식적으로 이를 SoftDelete를 지원하도록 하는 <code class=\"language-text\">@SoftDelete</code> 어노테이션을 제공한다.</p>\n<h2 id=\"1-softdelete\" style=\"position:relative;\"><a href=\"#1-softdelete\" aria-label=\"1 softdelete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. @SoftDelete</h2>\n<p>Spring Data JPA 경우 3.2.1 이상, Hibernate 6.4 이상부터 지원한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDelete</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span><span class=\"token punctuation\">(</span>columnName <span class=\"token operator\">=</span> <span class=\"token string\">\"deleted\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@SoftDelete</code> 어노테이션을 사용하면 JPA가 자동으로 bool 타입의 <code class=\"language-text\">deleted</code> 컬럼을 추가하고 delete() 메소드 호출 시 <code class=\"language-text\">deleted</code> 컬럼을 true로 변경해주는 쿼리를 자동으로 생성해준다.\n<code class=\"language-text\">@SoftDelete</code> 어노테이션을 사용하면 <code class=\"language-text\">@Where</code> 와 <code class=\"language-text\">@SQLDelete</code> 어노테이션을 사용하지 않아도 되기 때문에 코드가 간결해지고 유지보수하기 좋게 된다.</p>\n<p><code class=\"language-text\">@SoftDelete</code>는 다음 3가지 주요 기능을 제공한다</p>\n<ul>\n<li><code class=\"language-text\">strategy</code> : 삭제 방식을 지정할 수 있다. (기본값은 <code class=\"language-text\">SoftDeleteType.DELETED</code>)</li>\n<li><code class=\"language-text\">columnName</code> : 삭제 컬럼의 이름을 지정할 수 있다. (기본값은 <code class=\"language-text\">deleted</code> 컬럼명)</li>\n<li><code class=\"language-text\">converter</code> : 삭제 컬럼의 데이터 타입을 지정할 수 있다. (기본값은 Bool 타입의 <code class=\"language-text\">TrueFalseConverter</code>)</li>\n</ul>\n<h3 id=\"11-softdelete-컬럼-이름-변경하기\" style=\"position:relative;\"><a href=\"#11-softdelete-%EC%BB%AC%EB%9F%BC-%EC%9D%B4%EB%A6%84-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\" aria-label=\"11 softdelete 컬럼 이름 변경하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 @SoftDelete 컬럼 이름 변경하기</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDelete</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span><span class=\"token punctuation\">(</span>columnName <span class=\"token operator\">=</span> <span class=\"token string\">\"is_deleted\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약에 <code class=\"language-text\">deleted</code> 컬럼의 이름을 변경하고 싶다면 <code class=\"language-text\">columnName</code> 속성을 사용하면 된다.</p>\n<h3 id=\"12-softdelete-삭제-방식-변경하기\" style=\"position:relative;\"><a href=\"#12-softdelete-%EC%82%AD%EC%A0%9C-%EB%B0%A9%EC%8B%9D-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\" aria-label=\"12 softdelete 삭제 방식 변경하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 @SoftDelete 삭제 방식 변경하기</h3>\n<p><code class=\"language-text\">@SoftDelete</code> 는 삭제 방식도 변경할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDelete</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDeleteType</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">SoftDeleteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">SoftDeleteType.ACTIVE</code> 는 <code class=\"language-text\">true</code>이면 삭제되지 않는 것 즉 활성화된 것을 의미한다.\n<code class=\"language-text\">SoftDeleteType.DELETED</code>는 기본 전략인데 <code class=\"language-text\">true</code>이면 삭제된 것을 의미하고 <code class=\"language-text\">false</code>이면 삭제되지 않은 것을 의미한다.</p>\n<h3 id=\"13-softdelete-converter를-이용해-bool이-아닌-다른-데이터-타입으로-삭제-표시하기\" style=\"position:relative;\"><a href=\"#13-softdelete-converter%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%B4-bool%EC%9D%B4-%EC%95%84%EB%8B%8C-%EB%8B%A4%EB%A5%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%ED%83%80%EC%9E%85%EC%9C%BC%EB%A1%9C-%EC%82%AD%EC%A0%9C-%ED%91%9C%EC%8B%9C%ED%95%98%EA%B8%B0\" aria-label=\"13 softdelete converter를 이용해 bool이 아닌 다른 데이터 타입으로 삭제 표시하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 @SoftDelete Converter를 이용해 BOOL이 아닌 다른 데이터 타입으로 삭제 표시하기</h3>\n<p><code class=\"language-text\">@SoftDelete</code>는 <code class=\"language-text\">Converter</code>를 통해 <code class=\"language-text\">Bool</code> 타입이 아닌 다른 데이터 타입으로 삭제 표시 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDelete</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDeleteType</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">YesNoConverter</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">SoftDeleteType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span> converter <span class=\"token operator\">=</span> <span class=\"token class-name\">YesNoConverter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">YesNoConverter</code>를 사용하면 <code class=\"language-text\">Y</code>와 <code class=\"language-text\">N</code> 문자로 삭제 표시를 할 수 있다.</p>\n<p>그리고 여러 Convert를 사용해 다르게 삭제 표시를 할 수 있다.</p>\n<p><code class=\"language-text\">NumericBooleanConverter</code> : <code class=\"language-text\">1</code>과 <code class=\"language-text\">0</code>으로 삭제 표시를 할 수 있다.</p>\n<p><code class=\"language-text\">TrueFalseConverter</code> : <code class=\"language-text\">true</code>와 <code class=\"language-text\">false</code>로 삭제 표시를 할 수 있다.</p>\n<h2 id=\"2-기존-where-와-sqldelete-방식에서-softdelete-방식으로-변경하기\" style=\"position:relative;\"><a href=\"#2-%EA%B8%B0%EC%A1%B4-where-%EC%99%80-sqldelete-%EB%B0%A9%EC%8B%9D%EC%97%90%EC%84%9C-softdelete-%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\" aria-label=\"2 기존 where 와 sqldelete 방식에서 softdelete 방식으로 변경하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 기존 @Where 와 @SQLDelete 방식에서 @SoftDelete 방식으로 변경하기</h2>\n<p>기존 <code class=\"language-text\">@Where</code> 와 <code class=\"language-text\">@SQLDelete</code> 방식에서 <code class=\"language-text\">@SoftDelete</code> 방식으로 변경하고 싶다면 </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span> <span class=\"token comment\">// 추가</span>\n<span class=\"token comment\">// @Where(clause = \"deleted = false\") // 제거</span>\n<span class=\"token comment\">// @SQLDelete(sql = \"UPDATE member SET deleted = true WHERE id = ?\") // 제거</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// private boolean deleted; // @SoftDelete 어노테이션을 사용하면 deleted 컬럼을 추가하지 않아도 된다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@SoftDelete</code> 어노테이션을 추가하고 <code class=\"language-text\">@Where</code> 와 <code class=\"language-text\">@SQLDelete</code> 어노테이션을 제거하면 간단하게 된다.</p>\n<h2 id=\"3-manytoone-관계에서-softdelete-사용하기-위해선\" style=\"position:relative;\"><a href=\"#3-manytoone-%EA%B4%80%EA%B3%84%EC%97%90%EC%84%9C-softdelete-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%B4%EC%84%A0\" aria-label=\"3 manytoone 관계에서 softdelete 사용하기 위해선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. ManyToOne 관계에서 SoftDelete 사용하기 위해선</h2>\n<p>ManyToOne 관계에서 <code class=\"language-text\">@SoftDelete</code>를 사용하려면 즉시 전략으로 연관 관계를 조회해야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Post</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> content<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EAGER</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 즉시 로딩 (SoftDelete)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약에 지연 로딩 전략을 사용하면 <code class=\"language-text\">@SoftDelete</code>를 사용할 수 없다. 컴파일 시 다음과 같은 <code class=\"language-text\">UnsupportedMappingException</code> 예외가 발생한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">UnsupportedMappingException: To-one attribute cannot be mapped as LAZY as its associated entity is defined with @SoftDelete</code></pre></div>\n<p>일반적으로 @ManyToOne에서 가리키는 엔티티(One쪽)가 삭제되면 지연 로딩 시 <code class=\"language-text\">EntityNotFoundException</code>이 발생하는데\n<code class=\"language-text\">FetchType.EAGER</code>로 변경하면 초기화 시 엔티티를 가져오고 프록시가 호출되지 않으므로 작동하게 된다.\n그리고 해당 엔티티를 사용하게 되면 삭제되었기 때문에 DB에 조회되지 않고 <code class=\"language-text\">null</code>을 반환하게 된다.</p>\n<p>따라서 <code class=\"language-text\">@ManyToOne</code> 관계에서 <code class=\"language-text\">@SoftDelete</code>를 사용하려면 <strong>즉시 로딩 전략</strong>을 사용해야한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26ba261ab2c91811addf0a1c9e07e5c4/5caea/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIklEQVQ4y52UW3KcMBRE2YxjkAChF0i8Z5hx2eV4/8vpNPLYTipJJcxHF5QQR+deCbJcNFiGK97aKza74OJ6XP2ExUYMcYbuJoimg7QDpO5QFAoF3/lbMqkczssLXqcX9G5G040YphXb+AxjAlTjIaSGTDGQlYUsb/n5/pZspw7zFe16QdNvNOlRW4JchHQTKpoWQmGvJC/2qN/yi+EHsCNQdQt8OyIEmtLuUbFE06PgtWS5yse0YGkiKu3hA8crfYO+wxNwJDCen2DiCYpGmnZtmBiC/Q5oWZ5BwbK/0nBMJ6svSwKF0IjjhrBsiNMFYVgxr1ectmeEeYPpCFQWQvy53Pc0n8nKSqGqNRtfselMWfO+5mpVuspSYZ9T1g3n/TuZ6zxCDHDeQxvD3mloa9J9rdThZNY6xC5yI9i3toUnuGka1DXNq/pwspqNdX6EtTZFa5YvxN3hLhewzmLbtpTdcH8gpbwr2f7ybrYsC6ZpSoMfwHvACWi4Aeu6IsbI3tUoy/JuywR0NFxpmKAhJKD8sNwnHoBn3woaOofT5YJ+mqFou4/lfJjfYOKIYSdyzDx335cRbyf+vnguW/GIIHM4blhx1PBJPmLwHc7OYNE1Ahdo828YigdcxcOn5X8Dd4DQPIOh5xdioXgOa23SRi1cLBf7xCNAWeCB33JlW7Tc5TgMsHFAYz0Wlp4MjwBflcCoG1yswtkorE2FSNCU31fyDxHvbDpC1p5vAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt text\"\n        title=\"alt text\"\n        src=\"/static/26ba261ab2c91811addf0a1c9e07e5c4/fcda8/image.png\"\n        srcset=\"/static/26ba261ab2c91811addf0a1c9e07e5c4/12f09/image.png 148w,\n/static/26ba261ab2c91811addf0a1c9e07e5c4/e4a3f/image.png 295w,\n/static/26ba261ab2c91811addf0a1c9e07e5c4/fcda8/image.png 590w,\n/static/26ba261ab2c91811addf0a1c9e07e5c4/efc66/image.png 885w,\n/static/26ba261ab2c91811addf0a1c9e07e5c4/5caea/image.png 996w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n조회 시 JOIN ON 절에 <code class=\"language-text\">is_deleted=false</code> 조건이 추가되어 삭제되지 않은 데이터만 조회되는 모습이다.</p>\n<p>즉시 전략으로 N+1 문제를 방지할 수 있으나, Many 쪽에서 연관객체 조회 시 별도의 <code class=\"language-text\">null</code> 체크를 해야하고 <code class=\"language-text\">@SoftDelete</code>를 적용한 엔티티는 연관 관계 조회 시 성능적으로 잘 고려해서 사용해야한다.</p>\n<h2 id=\"4-flyway를-사용하고-있다면\" style=\"position:relative;\"><a href=\"#4-flyway%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8B%A4%EB%A9%B4\" aria-label=\"4 flyway를 사용하고 있다면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Flyway를 사용하고 있다면</h2>\n<p>만약에 Flyway를 사용하고 있어 JPA가 자동으로 DDL(ddl-auto)을 생성하지 않는다면\nFlyway가 자동으로 <code class=\"language-text\">deleted</code> 컬럼을 추가하지 않으므로 <strong><code class=\"language-text\">@SoftDelete</code>를 사용하려면 <code class=\"language-text\">deleted</code> 컬럼을 직접 추가해야한다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> member <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">COLUMN</span> deleted <span class=\"token keyword\">BOOLEAN</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>만약 기존에 <code class=\"language-text\">is_deleted</code> 컬럼으로 SoftDelete를 직접하고 있고 <code class=\"language-text\">@SoftDelete</code>를 적용하게 된다면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>hibernate<span class=\"token punctuation\">.</span>annotations<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SoftDelete</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@SoftDelete</span><span class=\"token punctuation\">(</span>columnName <span class=\"token operator\">=</span> <span class=\"token string\">\"is_deleted\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// private boolean is_deleted; // @SoftDelete 어노테이션을 사용하면 is_deleted 컬럼을 추가하지 않아도 된다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>columnName 속성을 사용해 컬럼 이름을 변경하면 지정된 <code class=\"language-text\">is_deleted</code> 컬럼으로 JPA는 삭제 처리를 한다.</p>\n<h2 id=\"레퍼런스\" style=\"position:relative;\"><a href=\"#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\" aria-label=\"레퍼런스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레퍼런스</h2>\n<ul>\n<li><a href=\"https://hibernate.org/orm/releases/6.4/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hibernate 6.4 Release Note</a></li>\n<li><a href=\"https://docs.jboss.org/hibernate/orm/6.4/javadocs/org/hibernate/annotations/SoftDelete.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hibernate 6.4 SoftDelete API</a></li>\n<li><a href=\"https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hibernate 6.4 UserGuide</a></li>\n<li><a href=\"https://www.baeldung.com/java-hibernate-softdelete-annotation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.baeldung.com/java-hibernate-softdelete-annotation</a></li>\n</ul>","excerpt":"기존에는 SoftDelete를 구현할려면 @Where 와 @SQLDelete 를 사용했어야했다. 는 Repository의  메서드를 호출했을 때, 대신 호출되는 SQL을 지정해주는 어노테이션인데 이를 통해 UPDATE 방식으로 삭제 처리를 하고 를 …","tableOfContents":"<ul>\n<li>\n<p><a href=\"/jpa-softdelete-annotation/#1-softdelete\">1. @SoftDelete</a></p>\n<ul>\n<li><a href=\"/jpa-softdelete-annotation/#11-softdelete-%EC%BB%AC%EB%9F%BC-%EC%9D%B4%EB%A6%84-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\">1.1 @SoftDelete 컬럼 이름 변경하기</a></li>\n<li><a href=\"/jpa-softdelete-annotation/#12-softdelete-%EC%82%AD%EC%A0%9C-%EB%B0%A9%EC%8B%9D-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\">1.2 @SoftDelete 삭제 방식 변경하기</a></li>\n<li><a href=\"/jpa-softdelete-annotation/#13-softdelete-converter%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%B4-bool%EC%9D%B4-%EC%95%84%EB%8B%8C-%EB%8B%A4%EB%A5%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%ED%83%80%EC%9E%85%EC%9C%BC%EB%A1%9C-%EC%82%AD%EC%A0%9C-%ED%91%9C%EC%8B%9C%ED%95%98%EA%B8%B0\">1.3 @SoftDelete Converter를 이용해 BOOL이 아닌 다른 데이터 타입으로 삭제 표시하기</a></li>\n</ul>\n</li>\n<li><a href=\"/jpa-softdelete-annotation/#2-%EA%B8%B0%EC%A1%B4-where-%EC%99%80-sqldelete-%EB%B0%A9%EC%8B%9D%EC%97%90%EC%84%9C-softdelete-%EB%B0%A9%EC%8B%9D%EC%9C%BC%EB%A1%9C-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0\">2. 기존 @Where 와 @SQLDelete 방식에서 @SoftDelete 방식으로 변경하기</a></li>\n<li><a href=\"/jpa-softdelete-annotation/#3-manytoone-%EA%B4%80%EA%B3%84%EC%97%90%EC%84%9C-softdelete-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%B4%EC%84%A0\">3. ManyToOne 관계에서 SoftDelete 사용하기 위해선</a></li>\n<li><a href=\"/jpa-softdelete-annotation/#4-flyway%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B3%A0-%EC%9E%88%EB%8B%A4%EB%A9%B4\">4. Flyway를 사용하고 있다면</a></li>\n<li><a href=\"/jpa-softdelete-annotation/#%EB%A0%88%ED%8D%BC%EB%9F%B0%EC%8A%A4\">레퍼런스</a></li>\n</ul>","fields":{"slug":"/jpa-softdelete-annotation/"},"frontmatter":{"title":"Hibernate 6.4 부터 SoftDelete를 공식적으로 지원한다","date":"Mar 28, 2024","tags":["Spring","JPA","Hibernate"],"keywords":["Spring","SpringBoot","JPA","Hibernate","SoftDelete"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/jpa-softdelete-annotation/","series":[],"lastmod":"2024-03-28"}},"staticQueryHashes":["2027115977","694178885"]}